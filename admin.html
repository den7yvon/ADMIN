<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EPI Admin Dashboard</title>
  <link rel="shortcut icon" type="image/x-icon" href="FAVICON LOGO.jpg">
  <style>
    body {margin: 0; font-family: Arial, sans-serif; background-color: #f4f4f4;}

    .top-nav {display: flex; justify-content: space-between; align-items: center; background-color: #2f0fe4;
      color: white; padding: 1rem; position: relative;}

    .menu-icon, .user-icon {font-size: 24px; cursor: pointer;}

    .page-title {font-size: 18px; font-weight: bold;}

    .dropdown-menu {position: absolute; top: 60px; left: 10px; background-color: white; box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      border-radius: 8px; display: none; flex-direction: column; z-index: 1000;}

    .dropdown-menu a {text-decoration: none; color: #2f0fe4; padding: 10px 20px; display: flex; align-items: center;
      border-bottom: 1px solid #eee;}

    .dropdown-menu a:hover {background-color: #f0f0ff;}

    .dropdown-menu a::before {content: "âž¤"; margin-right: 10px;}

    .user-dropdown {position: absolute; top: 60px; right: 10px; background-color: white; box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      border-radius: 8px; display: none; flex-direction: column; z-index: 1000;}

    .user-dropdown button {background: none; border: none; padding: 10px 20px; color: #2f0fe4; font-size: 16px;
      text-align: left; cursor: pointer;}

    .user-dropdown button:hover {background-color: #f0f0ff;}

    footer {position: fixed; bottom: 0; left: 0; width: 100%; background-color: #2f0fe4; color: white; text-align: center;
      padding: 10px 0; font-size: 14px;}

    .user-icon {width: 32px; height: 32px; border-radius: 50%; background: white; border: 2px solid #fff;
      display: inline-block; position: relative;}

    .user-icon::after {content: ""; position: absolute; bottom: 5px; left: 50%; transform: translateX(-50%); width: 12px;
      height: 12px; background: #2f0fe4; border-radius: 50%;}

    #pageLoader {position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9);
      z-index: 9999; display: flex; align-items: center; justify-content: center;}

    .spinner {border: 6px solid #ccc; border-top: 6px solid #2f0fe4; border-radius: 50%; width: 40px; height: 40px;
      animation: spin 1s linear infinite;}

    @keyframes spin {0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); }}
      
    .lock-screen, .analysis-page {display: flex; flex-direction: column; align-items: center; justify-content: center;
      background: #f0f2f5;}

    .lock-screen input {padding: 10px; border-radius: 8px; border: 1px solid #ccc; margin-top: 10px; width: 250px;}

    .lock-screen button {margin-top: 10px; padding: 8px 16px; border-radius: 8px; background: #007bff; color: #fff;
      border: none; cursor: pointer; font-weight: bold;}

    .analysis-box {background: linear-gradient(90deg, rgb(247, 17, 178),rgb(46, 5, 228), rgb(247, 17, 178));
      padding: 2px 10px; border-radius: 12px; box-shadow: 0 0 10px rgba(0,0,0,0.05); text-align: center;
      max-width: fit-content; width: 100%; border-left: 6px solid blue; border-right: 6px solid blue;}

    .analysis-box h2 {margin-bottom: 20px; color: white;}

    .analysis-box p {margin: 10px 0; font-size: 16px; color: white; text-align: left;}
  </style>
</head>
<body>
    <!-- Loader Spinner -->
    <div id="pageLoader">
        <div class="spinner"></div>
    </div>  

    <!-- Top Navigation -->
    <div class="top-nav">
        <div>
        <span class="menu-icon" onclick="toggleMenu()">â˜°</span>
        <span class="page-title" id="activePage">Dashboard</span>
        </div>
        <div class="user-icon" onclick="toggleUserMenu()"></div>

    </div>

    <!-- Dropdown Menu -->
    <div class="dropdown-menu" id="menuDropdown">
        <a href="dashboard.html">Dashboard</a>
        <a href="investment-plans.html">Investment Plans</a>
        <a href="announcements.html">Announcements</a>
        <a href="admin.html">Admin</a>
    </div>

    <!-- User Menu -->
    <div class="user-dropdown" id="userDropdown">
        <button onclick="logout()">Logout</button>
    </div>

    <!-- Main Content Placeholder -->
    <div style="text-align: center;">
        <h2>Welcome, Admin ðŸ‘‹</h2>
        <p>This is your dashboard overview. Users will load here.</p>
    </div>

    <div id="adminLockScreen" class="lock-screen">
      <h2>Enter Admin Key</h2>
      <input type="password" id="adminKeyInput" placeholder="Admin Key">
      <button onclick="unlockAdminPage()">Unlock</button>
    </div>
    
    <div id="adminAnalysisPage" class="analysis-page" style="display:none;">
      <div class="analysis-box">
        <h2>ADMIN ANALYSIS</h2>
        <p><strong>Total Investors:</strong> <span id="totalInvestors">0</span></p>
        <p><strong>Total Investments:</strong> Ksh.<span id="totalInvestments">0</span></p>
        <p><strong>Completed Withdrawals:</strong> Ksh.<span id="completedWithdrawals">0</span></p>
        <p><strong>Account:</strong> Ksh.<span id="accountBalance">0</span></p>
        <p><strong>Credibility Status:</strong> <span id="credibilityStatus">N/A</span></p>
      </div>
    </div>
    
    <!-- Footer -->
    <footer>
        &copy; EPI Company Limited 2025
    </footer>

    <!-- Script -->
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
    const supabaseUrl = 'https://drivactdliyzcshlousw.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRyaXZhY3RkbGl5emNzaGxvdXN3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY1NTY4ODUsImV4cCI6MjA2MjEzMjg4NX0.7NYTI6cZIjsQoxCwBjj4ELbSEvEQqrR66fNB3PNNVDo';

    const { createClient } = supabase;
    const client = createClient(supabaseUrl, supabaseKey);
    </script>
  
    <script>
        window.addEventListener("load", () => {
        document.getElementById("pageLoader").style.display = "none";
        });

        // Optional global control for Supabase calls
        function showLoader() {
        document.getElementById("pageLoader").style.display = "flex";
        }

        function hideLoader() {
        document.getElementById("pageLoader").style.display = "none";
        }

        const activePageName = "Admin"; // Update this per page
        document.getElementById("activePage").textContent = activePageName;

        function toggleMenu() {
            const menu = document.getElementById("menuDropdown");
            menu.style.display = menu.style.display === "flex" ? "none" : "flex";
        }

        function toggleUserMenu() {
            const menu = document.getElementById("userDropdown");
            menu.style.display = menu.style.display === "flex" ? "none" : "flex";
        }

        function logout() {
            window.location.href = "login.html"; // Adjust to your login page
        }

        // Optional: Close dropdowns when clicking outside
        document.addEventListener("click", (e) => {
        if (!e.target.closest(".top-nav") && !e.target.closest(".dropdown-menu")) {
            document.getElementById("menuDropdown").style.display = "none";
        }
        if (!e.target.closest(".user-icon") && !e.target.closest(".user-dropdown")) {
            document.getElementById("userDropdown").style.display = "none";
        }
        });

        async function unlockAdminPage() {
          const key = document.getElementById('adminKeyInput').value.trim();
          if (key === 'ADMINUNLOCKKEY') {
            document.getElementById('adminLockScreen').style.display = 'none';
            document.getElementById('adminAnalysisPage').style.display = 'flex';
            loadAdminAnalysis();
          } else {
            alert('Invalid Admin Key.');
          }
        }

        async function loadAdminAnalysis() {
          try {
            const { data: users } = await client.from('users').select('*');
            const { data: investments } = await client.from('investments').select('principal');
            const { data: withdraws } = await client.from('withdraws').select('amount, status');

            const totalInvestors = users.length;

            const totalInvestments = investments.reduce((sum, inv) => sum + parseFloat(inv.principal || 0), 0);

            const completedWithdrawals = withdraws
              .filter(w => w.status && w.status.toLowerCase() === 'completed')
              .reduce((sum, w) => sum + parseFloat(w.amount || 0), 0);

            const account = totalInvestments - completedWithdrawals;

            let status = 'N/A';
            if (account >= 0 && account <= 10000) status = 'Start Up';
            else if (account >= 10001 && account <= 50000) status = 'Building Up';
            else if (account >= 50001 && account <= 100000) status = 'Advancing';
            else if (account >= 100001 && account <= 500000) status = 'Leveling';
            else if (account >= 500001 && account <= 1000000) status = 'Stability';
            else if (account > 1000000) status = 'High End';

            document.getElementById('totalInvestors').textContent = totalInvestors;
            document.getElementById('totalInvestments').textContent = totalInvestments.toLocaleString();
            document.getElementById('completedWithdrawals').textContent = completedWithdrawals.toLocaleString();
            document.getElementById('accountBalance').textContent = account.toLocaleString();
            document.getElementById('credibilityStatus').textContent = status;

          } catch (err) {
            console.error('Error loading admin analysis:', err);
            alert('Failed to load data. Please try again.');
          }
        }
  </script>
</body>
</html>
